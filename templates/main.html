<!DOCTYPE html>
<html lang="en">
<head>
    <title>Looper</title>
    <link rel="icon" href="/static/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="/static/jquery-3.6.0.js"></script>
    <link rel="stylesheet" href="/static/font-awesome-4.7.0/css/font-awesome.min.css">

    <!-- bootstrap start -->
    <link rel="stylesheet" href="/static/bootstrap-5.2.0-dist/css/bootstrap.min.css">
    <!-- bootstrap end -->

    <!-- sweet alert start -->
    <script src="/static/sweetalert2-dist/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="static/sweetalert2-dist/sweetalert2.min.css">
    <!-- sweet alert end-->
    <style>
        html, body {
            height: 100%;
            width: 100%;
            border: 0;
            margin: 0;
            padding: 0;
        }
        .table-wrapper {
            height: 100%;
            max-height: 100%;
            overflow: scroll;
            width: 100%;
            padding: 0;
        }
    </style>
</head>
<body>
<div class="container-fluid h-100 w-100 d-flex flex-column">
<div class="row">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üîÅ Looper</span>
            <span id="stream" class="navbar-text"></span>
            <span><button type="button" onclick="poweroff()" class="btn btn-primary"><i class="fa fa-power-off" aria-hidden="true"></i></button></span>
            </div>
    </nav>
</div>
<div class="row" style="height:60%;">
    <div class="table-wrapper">
        <table id="recordings" class="table table-hover">
            <thead class="table-light sticky-top">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">State</th>
                    <th scope="col">Vol</th>
                    <th scope="col">Time</th>
                    <th scope="col" style="text-align: center;">Playblack</th>
                    <th scope="col">Length</th>
                    <th scope="col">Control</th>
                    <th scope="col">Download</th>
                    <th scope="col">Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div class="row">
    <button type="button" class="btn btn-light w-100" onclick="pauseAll()">Pause all</button>
    <hr>
    <form class="w-100">
        <div class="row">
            <div class="col">
                <input id="recordName" class="form-control" type="text" value="" placeholder="Name (optional)">
            </div>
        <div class="col" style="margin-top: 5px;">
            <div class="form-check form-check-inline" style="text-align: center;">
                <label class="form-check-label" for="autoLoopCheckbox">Play after recording</label><input class="form-check-input" type="checkbox" value="" id="autoLoopCheckbox">
            </div>
        </div>
        </div>
    </form>
</div>
<div class="row flex-grow-1 w-100" style="margin: 10px 0px 10px 0px;">
    <button type="button" id="record" class="btn btn-primary btn-lg w-100 h-100"></button>
</div>
</div>
</body>
<script>
    var firstLoad = true;
    var lastState = null;
    var lastStateTime = null;
    var dirtyState = false;
    var isUpdating = false;
    var nextKey = null;

    var recordHTML = "Record<br>(<i class=\"fa fa-keyboard-o\"></i> space)"
    var recordStopHTML = "Stop Recording<br>(<i class=\"fa fa-keyboard-o\"></i> space)"
    $("#record").html(recordHTML);

    var rows = {};

    function update() {
        if (isUpdating) {
            return;
        }

        isUpdating = true;
        dirtyState = true;

        // get status and update DOM
        $.get("/status", function(data) {
            lastState = JSON.parse(data);
            lastStateTime = new Date();
            // get new key
            const keys = Object.keys(lastState.recordings);
            if (keys.length > 0) {
                nextKey = Math.max(...Object.keys(lastState.recordings).map(Number)) + 1;
            }
            else {
                nextKey = 0;
            }
            updateRecordingsTable();
            dirtyState = false;
            isUpdating = false;
        }).fail(function() {
            isUpdating = false;
        });
    }

    function createRow(key) {
        var row = document.createElement("tr");
        row.key = key;
        row.innerHTML = `
            <td></td>
            <td></td>
            <td></td> 
            <td></td>
            <td style="text-align: center;"><input type="range" min="0" max="1" value="0" step="any" key='${key}'></td>
            <td></td>
            <td><input type='button' class="btn btn-dark btn-sm" name='loopKeyButton' key='${key}'></td>
            <td><form method="get" action="/download/${key}"><button type="submit" class="btn btn-dark btn-sm"><i class="fa fa-download" aria-hidden="true"></i></button></form></td>
            <td><button type='button' class="btn btn-dark btn-sm" name='deleteButton' key='${key}'><i class="fa fa-trash" aria-hidden="true"></i></button>`;
        return $(row);
    }

    function updateRecordingsTable() {
        if (lastState == null) {
            return;
        }

        if (lastState.stream.active) {
            $("#stream").html(`
                ${lastState.stream.samplerate} Hz | 
                device ${lastState.stream.device} |
                ${(lastState.stream.duration_stats.mean * 1000).toFixed(2)} ¬± ${(lastState.stream.duration_stats.std * 1000).toFixed(2)} ms 
                (99p: ${(lastState.stream.duration_stats['99p'] * 1000).toFixed(2)},
                max: ${(lastState.stream.duration_stats['max'] * 1000).toFixed(2)})
            `);
        }
        else {
            $("#stream").html(`<b>not active</b>`);
        }

        // new keys in the state => add
        var newKeys = [];
        // unused keys in the rows => remove
        var unusedKeys = Object.keys(rows);
        for (const key of Object.keys(lastState.recordings)) {
            if (key in rows) {
                unusedKeys.splice(unusedKeys.indexOf(key), 1);
            }
            else {
                newKeys.push(key);
            }
        }

        // remove unused rows from DOM
        for (const key of unusedKeys) {
            rows[key].remove();
            delete rows[key];
        }

        // create new rows
        for (const key of newKeys) {
            rows[key] = createRow(key);
            $("#recordings > tbody").append(rows[key]);
        }

        // update table values
        for (const [key, recording] of Object.entries(lastState.recordings)) {
            var length = recording.length / lastState.stream.samplerate;
            var time = recording.frame / lastState.stream.samplerate;
            if (recording.state == 'record') {
                // interpolate length
                length += (new Date() - lastStateTime) / 1000;
            }
            if (recording.state == 'loop') {
                // interpolate time
                time += (new Date() - lastStateTime) / 1000;
                time = time % length;
            }

            // update values
            var row = rows[key];
            const id = key + (recording.name == '' ? '' : ':' + recording.name);
            $("td:nth-child(1)", row).html(`${id}`);
            $("td:nth-child(2)", row).html(`${recording.state}`);
            $("td:nth-child(3)", row).html(`${recording.volume}`);
            $("td:nth-child(4)", row).html(`${time.toFixed(2)}`);
            if (recording.state != 'pause' || firstLoad) {
                $("td:nth-child(5) > input", row).val(time / length);
            }
            $("td:nth-child(6)", row).html(`${length.toFixed(2)}`);
            $("td > input[name='loopKeyButton']", row).val(recording.state == 'loop' ? '‚è∏' : '‚ñ∂');
        }

        firstLoad = false;
    }

    function setPlaybackTime(key, time) {
        // set frame
        const frame = Math.floor(time * (lastState.recordings[key].length - 1));
        $.get("/set-frame/" + key + "/" + frame, function() {
            update();
        });
    }

    $('#recordings').on('click', "tbody > tr > td > input[name='loopKeyButton']", function(e) {
        e.preventDefault();
        const target = $(e.target);
        loopKey(target.attr('key'));
    });

    $('#recordings').on('click', "tbody > tr > td > button[name='deleteButton']", function(e) {
        e.preventDefault();
        const target = $(e.target);
        console.log(target);
        deleteKey(target.attr('key'));
    });

    $('#recordings').on('click', "tbody > tr > td > input[type='range']", function(e) {
        // TODO: Disable animation on hover / click to get desired target value & set slider & frame accordingly
        setPlaybackTime($(e.target).attr('key'), $(e.target).val());
    });

    function loopKey(key) {
        if (dirtyState) {
            return;
        }

        const state = lastState.recordings[key].state;
        if (state == "pause") {
            $.get("/loop/" + key, function( data ) {
                update();
            });
        }
        else if (state == "loop") {
            $.get("/pause/" + key, function( data ) {
                update();
            });
        }
    }

    function deleteKey(key) {
        if (dirtyState) {
            return;
        }

        $.get("/delete/" + key, function(data) {
            update();
        });
    }

    function pauseAll() {
        $.get("/pause", function(data) {
            update();
        });
    }

    function poweroff() {
        Swal.fire({
            title: 'Shutdown looper',
            text: "Are you sure you want to shut down?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'No, I am not done yet.',
            cancelButtonText: "Yes, shut down!",
            }).then((result) => {
                if (!result.isConfirmed) {
                    $.get("/poweroff", function(data) {});
            }
        })
    }

    var currentRecordingKey = null;
    var loopAfterRecord = false;
    var isRecording = false;

    $("#record").click(function(){
        if (isRecording) {
            recordStop();
        }
        else {
            loopAfterRecord = ($("#autoLoopCheckbox").is(':checked'));
            recordStart();
        }
    });

    function recordStart() {
        if (currentRecordingKey != null) {
            return;
        }
        const key = nextKey;
        currentRecordingKey = key;
        const name = $('input[id="recordName"]').val();
        $('input[id="recordName"]').val("");
        // TODO: Error handling...
        $.get("/delete/" + key, function(data) {
            if (name != '') {
                $.get("/set-name/" + key + "/" + name, function() {});
            }
            $.get("/record/" + key, function(data) {
                // we started recording
                isRecording = true;
                $("#record").html(recordStopHTML);
                $("#record").removeClass("btn-primary").addClass("btn-success");
                update();
            });
        });
    }

    function recordStop() {
        if (currentRecordingKey == null) {
            return;
        }
        const key = currentRecordingKey;
        const action = loopAfterRecord ? "/loop/" : "/pause/";
        $.get(action + key, function(data) {
            // we stopped recording
            isRecording = false;
            $("#record").html(recordHTML);
            $("#record").removeClass("btn-success").addClass("btn-primary");
            update();
            currentRecordingKey = null;
        });
    }

    $('body').keyup(function(e){
       // space
        if(e.keyCode == 32){
            if (currentRecordingKey == null) {
                loopAfterRecord = true;
                recordStart();
            }
            else {
                recordStop();
            }
        }
    });

    setInterval(() => {
        updateRecordingsTable();
    }, 50);

    setInterval(() => {
        update();
    }, 2500);
    update();
</script>
</html>